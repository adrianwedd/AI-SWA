version: '3'
services:
  orchestrator:
    build:
      context: .
      dockerfile: orchestrator/Dockerfile
    volumes:
      - ./tasks.yml:/app/tasks.yml
      - ./state.json:/app/state.json
      - ./config.yaml:/app/config.yaml
    environment:
      BROKER_URL: http://broker:8000
      WORKER_METRICS_PORT: "9001"
      BROKER_METRICS_PORT: "9000"
    depends_on:
      - broker
      - worker
      - io-service
  broker:
    build:
      context: .
      dockerfile: broker/Dockerfile
    environment:
      DB_PATH: /data/tasks.db
      BROKER_METRICS_PORT: "9000"
    volumes:
      - broker-data:/data
    ports:
      - "8000:8000"
      - "9000:9000"
  worker:
    build:
      context: .
      dockerfile: worker/Dockerfile
    environment:
      BROKER_URL: http://broker:8000
      WORKER_METRICS_PORT: "9001"
    depends_on:
      - broker
    ports:
      - "9001:9001"
  orchestrator-api:
    build:
      context: .
      dockerfile: orchestrator_api/Dockerfile
    depends_on:
      - orchestrator
    ports:
      - "8002:8002"
  api-gateway:
    build:
      context: .
      dockerfile: api_gateway/Dockerfile
    environment:
      BROKER_URL: http://broker:8000
      ORCH_URL: http://orchestrator-api:8002
    depends_on:
      - broker
      - orchestrator-api
    ports:
      - "8080:8080"
  io-service:
    build: ./services/node
    environment:
      PORT: "50051"
      METRICS_PORT: "9100"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9100/health"]
      interval: 5s
      timeout: 2s
      retries: 3
    ports:
      - "50051:50051"
      - "9100:9100"
    volumes:
      - node-data:/data

volumes:
  broker-data:
  node-data:
